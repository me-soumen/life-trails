<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Life Trails</title>
    <link rel="icon" type="image/png" href="../../public/images/favicon.png">
    <link rel="apple-touch-icon" href="../../public/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../public/css/main.css">
    <link rel="stylesheet" href="../../public/css/theme.css">
</head>
<body>
    <header>
        <div class="header-container">
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menu" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a href="../../../" class="logo">
                <img src="../../public/images/logo.png" alt="Life Trails" class="logo-img">
                <span>Life Trails</span>
            </a>
            <nav class="header-nav"></nav>
            <div class="header-actions mobile-only">
                <button class="theme-toggle theme-toggle-light mobile-theme-toggle" onclick="window.themeManager.toggle()" aria-label="Toggle theme" data-theme="light">
                    <div class="theme-toggle-track">
                        <div class="theme-toggle-knob">
                            <svg class="theme-toggle-icon theme-toggle-icon-sun" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <svg class="theme-toggle-icon theme-toggle-icon-moon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
        <div class="mobile-menu-backdrop" id="mobileMenuBackdrop"></div>
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h3>Menu</h3>
            </div>
            <div class="mobile-menu-content">
                <a href="../add/event/" class="mobile-menu-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Add Event</span>
                </a>
                <a href="../add/family/" class="mobile-menu-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Add Family</span>
                </a>
                <button onclick="window.auth.signOut(); window.location.href='../../';" class="mobile-menu-item mobile-menu-btn-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </header>

    <div class="dashboard-layout">
        <!-- Desktop: Left Sidebar for Years -->
        <aside class="years-sidebar desktop-only" id="yearsSidebar">
            <div class="years-sidebar-content">
                <div class="years-sidebar-title">Years</div>
                <nav class="years-nav" id="yearNav"></nav>
            </div>
        </aside>

        <div class="dashboard-main">
            <div class="dashboard-header">
                <div class="profile" id="profile"></div>
                <!-- Mobile: View Family Button (emoji only) - Right side of title -->
                <div class="mobile-family-btn mobile-only">
                    <button onclick="openFamily()" class="btn btn-primary family-emoji-btn" title="View Family">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                </div>
                <div class="action-buttons desktop-only">
                <a href="../add/event/" class="btn btn-primary action-emoji-btn" title="Add Event">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </a>
                <button onclick="openFamily()" class="btn btn-primary action-emoji-btn" title="View Family">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </button>
                <button onclick="window.loadSampleData && window.loadSampleData()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" title="Load sample family data">ðŸ“‹ Load Sample Data</button>
            </div>
            </div>
            
                <div class="search">
                    <input id="search" type="text" placeholder="Search by year, date, title, or description..." autocomplete="off" />
                </div>

            <!-- Mobile: Horizontal Years Strip -->
            <div class="years-strip-container mobile-only">
                <div class="years-strip" id="yearNavMobile"></div>
            </div>

            <div class="timeline-container">
                <div id="timeline"></div>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTop" aria-label="Scroll to top" onclick="scrollToTop()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="image-modal-wrapper" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">Ã—</button>
            <img id="modalImg" alt="Event image" />
        </div>
    </div>

    <!-- Family Modal -->
    <div class="modal" id="familyModal" onclick="closeFamily()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Family Tree</h2>
                <button class="modal-close" onclick="closeFamily()">Ã—</button>
            </div>
            <div id="familyTree"></div>
        </div>
    </div>

    <script src="../../public/js/theme.js"></script>
    <script src="../../public/js/auth.js"></script>
    <script src="../../public/js/events.js"></script>
    <script src="../../public/js/family.js"></script>
    <script src="../../public/js/app.js"></script>
    <script>
        // Check authentication
        if (!window.auth.requireAuth()) {
            // Redirect will happen in auth.js
        }

        let allEvents = [];

        function init() {
            const user = window.auth.getCurrentUser();
            if (!user) return;

            // Get data
            const data = window.eventsManager.getUserData();
            const profile = document.getElementById('profile');
            const timeline = document.getElementById('timeline');
            const yearNav = document.getElementById('yearNav'); // Desktop sidebar
            const yearNavMobile = document.getElementById('yearNavMobile'); // Mobile strip
            const search = document.getElementById('search');

            // Render profile
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === 'Not set') return 'Not set';
                // Try to parse DD-MM-YYYY format
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = parts[2];
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    const monthName = monthNames[parseInt(month) - 1] || month;
                    return `${monthName} ${day}, ${year}`;
                }
                return dateStr;
            };
            
            profile.innerHTML = `
                <h1>${window.app.escapeHtml(data.name)}'s Life Trails</h1>
                <div class="meta">
                    <span class="meta-item">
                        <svg class="meta-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span class="meta-label">Born:</span>
                        <span class="meta-value">${formatDate(data.dateOfBirth || 'Not set')}</span>
                    </span>
                    <span class="meta-item">
                        <svg class="meta-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span class="meta-label">Location:</span>
                        <span class="meta-value">${window.app.escapeHtml(data.placeOfBirth || 'Not set')}</span>
                    </span>
                </div>
            `;

            // Get all events
            allEvents = window.eventsManager.getAllEvents();
            
            // Debug: Log events and years
            if (data && data.events) {
                const yearKeys = Object.keys(data.events);
            }

            // Get unique years (reverse chronological)
            const years = [...new Set(allEvents.map(e => e.year))].sort((a, b) => b - a);
            let selectedYear = years.length > 0 ? years[0] : null; // Default to latest year

            function render(filter = '') {
                timeline.innerHTML = '';
                if (yearNav) yearNav.innerHTML = '';
                if (yearNavMobile) yearNavMobile.innerHTML = '';

                // Filter events
                const filteredEvents = filter
                    ? allEvents.filter(e => {
                        const searchText = filter.toLowerCase();
                        return (
                            e.year.includes(searchText) ||
                            e.date.toLowerCase().includes(searchText) ||
                            e.title.toLowerCase().includes(searchText) ||
                            e.description.toLowerCase().includes(searchText) ||
                            (e.place && e.place.toLowerCase().includes(searchText))
                        );
                    })
                    : allEvents;

                if (filteredEvents.length === 0) {
                    timeline.innerHTML = `
                        <div class="empty-state">
                            <h3>No events found</h3>
                            <p>Try adjusting your search terms or <a href="../add/event/">add your first event</a>.</p>
                        </div>
                    `;
                    return;
                }

                // Group by year
                const eventsByYear = {};
                filteredEvents.forEach(event => {
                    if (!eventsByYear[event.year]) {
                        eventsByYear[event.year] = [];
                    }
                    eventsByYear[event.year].push(event);
                });

                // Get sorted years
                const sortedYears = Object.keys(eventsByYear).sort((a, b) => b - a);
                
                // If no year selected or selected year not in filtered results, select first year
                if (!selectedYear || !sortedYears.includes(selectedYear)) {
                    selectedYear = sortedYears.length > 0 ? sortedYears[0] : null;
                }

                // Render year navigation (desktop sidebar and mobile strip)
                sortedYears.forEach(year => {
                    const yearId = `year-${year}`;
                    const isSelected = year === selectedYear;
                    const yearLink = `<a class="year-link ${isSelected ? 'active' : ''}" href="#${yearId}" data-year="${year}">${year}</a>`;
                    if (yearNav) yearNav.innerHTML += yearLink;
                    if (yearNavMobile) yearNavMobile.innerHTML += yearLink;
                });

                // Scroll to selected year (mobile strip only)
                if (selectedYear && yearNavMobile) {
                    setTimeout(() => {
                        const activeLink = yearNavMobile.querySelector(`.year-link.active`);
                        if (activeLink) {
                            activeLink.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }
                    }, 100);
                }

                // Render timeline
                Object.keys(eventsByYear).sort((a, b) => b - a).forEach(year => {
                    const yearId = `year-${year}`;
                    const section = document.createElement('div');
                    section.className = 'section';
                    section.id = yearId;

                    const yearHeader = document.createElement('div');
                    yearHeader.className = 'year';
                    yearHeader.textContent = year;
                    section.appendChild(yearHeader);

                    // Group events by month (reverse chronological)
                    const eventsByMonth = {};
                    eventsByYear[year].forEach(event => {
                        const month = new Date(event.date).toLocaleString('default', { month: 'long' });
                        if (!eventsByMonth[month]) {
                            eventsByMonth[month] = [];
                        }
                        eventsByMonth[month].push(event);
                    });

                    // Sort months reverse chronologically
                    const sortedMonths = Object.keys(eventsByMonth).sort((a, b) => {
                        const monthA = new Date(`${year}-${window.app.getMonthNumber(a)}-01`);
                        const monthB = new Date(`${year}-${window.app.getMonthNumber(b)}-01`);
                        return monthB - monthA;
                    });

                    sortedMonths.forEach(month => {
                        const monthGroup = document.createElement('div');
                        monthGroup.className = 'month-group';

                        const monthHeader = document.createElement('div');
                        monthHeader.className = 'month';
                        monthHeader.textContent = month;
                        monthGroup.appendChild(monthHeader);

                        // Sort events within month (reverse chronological - latest first)
                        const monthEvents = eventsByMonth[month].sort((a, b) => b.sortDate - a.sortDate);

                        monthEvents.forEach(event => {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'event';

                            // Limit images to 2
                            const displayImages = (event.images || []).slice(0, 2);
                            const imageClass = displayImages.length === 1 ? 'single' : '';
                            const user = window.auth.getCurrentUser();

                            eventDiv.innerHTML = `
                                <div class="card">
                                    <div class="meta-line">
                                        <span class="meta-item">
                                            <svg class="meta-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            <span class="meta-value">${window.app.escapeHtml(event.date)}</span>
                                        </span>
                                        <span class="meta-item">
                                            <svg class="meta-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12 6 12 12 16 14"></polyline>
                                            </svg>
                                            <span class="meta-value">${window.app.escapeHtml(event.time)}</span>
                                        </span>
                                        ${event.place ? `<span class="meta-item">
                                            <svg class="meta-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                                <circle cx="12" cy="10" r="3"></circle>
                                            </svg>
                                            <span class="meta-value">${window.app.escapeHtml(event.place)}</span>
                                        </span>` : ''}
                                    </div>
                                    <div class="event-title">${window.app.escapeHtml(event.title)}</div>
                                    <div class="event-description">${window.app.escapeHtml(event.description)}</div>
                                    ${displayImages.length > 0 ? `
                                        <div class="images ${imageClass}">
                                            ${displayImages.map(img => {
                                                const imageUrl = window.app.getImageUrl(user.userId, img);
                                                return `
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(event.title)}" 
                                                     onerror="this.style.display='none'"
                                                     onclick="openImageModal('${imageUrl}')" />
                                            `;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;

                            monthGroup.appendChild(eventDiv);
                        });

                        section.appendChild(monthGroup);
                    });

                    timeline.appendChild(section);
                });
            }

            search.addEventListener('input', (e) => {
                render(e.target.value);
            });

            // Handle year link clicks (both desktop and mobile)
            function handleYearClick(e) {
                if (e.target.classList.contains('year-link')) {
                    e.preventDefault();
                    const clickedYear = e.target.getAttribute('data-year');
                    
                    // Update selected year
                    selectedYear = clickedYear;
                    
                    // Update active state in both navs
                    if (yearNav) {
                        yearNav.querySelectorAll('.year-link').forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('data-year') === clickedYear) {
                                link.classList.add('active');
                            }
                        });
                    }
                    if (yearNavMobile) {
                        yearNavMobile.querySelectorAll('.year-link').forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('data-year') === clickedYear) {
                                link.classList.add('active');
                            }
                        });
                        // Scroll to selected year in mobile strip
                        e.target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                    
                    // Scroll to year section in timeline
                    const targetId = e.target.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
            
            if (yearNav) {
                yearNav.addEventListener('click', handleYearClick);
            }
            if (yearNavMobile) {
                yearNavMobile.addEventListener('click', handleYearClick);
            }

            // Auto-scroll to latest year on initial load (mobile only)
            if (selectedYear && yearNavMobile) {
                setTimeout(() => {
                    const activeLink = yearNavMobile.querySelector(`.year-link.active`);
                    if (activeLink) {
                        activeLink.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        const targetId = activeLink.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            setTimeout(() => {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 300);
                        }
                    }
                }, 200);
            }

            render();
        }

        // Image Modal
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            modalImg.src = imageSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Family Modal
        function openFamily() {
            const modal = document.getElementById('familyModal');
            const familyTree = document.getElementById('familyTree');

            const allFamily = window.familyManager.getFamily();
            
            // Separate regular family and extended family (Others)
            const regularFamily = allFamily.filter(m => m.relation !== 'Others');
            const extendedFamily = allFamily.filter(m => m.relation === 'Others');

            if (regularFamily.length === 0 && extendedFamily.length === 0) {
                familyTree.innerHTML = `
                    <div class="empty-state">
                        <h3>No family members added yet</h3>
                        <p><a href="../add/family/">Add your first family member</a></p>
                    </div>
                `;
            } else {
                let html = '';
                
                // Build main family tree (excluding Others)
                if (regularFamily.length > 0) {
                    const familyLevels = {};
                    regularFamily.forEach(member => {
                        if (!familyLevels[member.level]) {
                            familyLevels[member.level] = [];
                        }
                        familyLevels[member.level].push(member);
                    });

                    const sortedLevels = Object.keys(familyLevels)
                        .map(Number)
                        .sort((a, b) => a - b);

                    sortedLevels.forEach((level, index) => {
                        const generation = familyLevels[level];
                        const user = window.auth.getCurrentUser();
                        
                        // Special handling for level 0 (Self/Siblings/Spouse)
                        if (level === 0) {
                            const self = generation.filter(m => m.relation === 'Self');
                            const spouse = generation.filter(m => m.relation === 'Spouse');
                            const siblings = generation.filter(m => m.relation === 'Brother' || m.relation === 'Sister');
                            
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${[...self, ...spouse].map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            const isSelf = member.relation === 'Self';
                                            return `
                                            <div class="family-member ${isSelf ? 'family-member-self' : ''}">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     class="${isSelf ? 'family-member-self-img' : ''}"
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name ${isSelf ? 'family-member-self-name' : ''}">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation === 'Self' ? 'Self' : 'Spouse')}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                        ${siblings.length > 0 ? '<div class="generation-separator-inline">â”‚</div>' : ''}
                                        ${siblings.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">â”‚</div>' : ''}
                                </div>
                            `;
                        } else if (level === -2) {
                            // Special handling for grandparents - separate Father Side and Mother Side
                            const fatherSide = generation.filter(m => m.relation.includes('Father Side'));
                            const motherSide = generation.filter(m => m.relation.includes('Mother Side'));
                            
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${fatherSide.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                        ${motherSide.length > 0 ? '<div class="generation-separator-inline">â”‚</div>' : ''}
                                        ${motherSide.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">â”‚</div>' : ''}
                                </div>
                            `;
                        } else {
                            // Other levels (parents, grandparents, children)
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${generation.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">â”‚</div>' : ''}
                                </div>
                            `;
                        }
                    });
                }

                // Add Extended Family Members section
                if (extendedFamily.length > 0) {
                    const user = window.auth.getCurrentUser();
                    html += `
                        <div style="margin-top: 60px; padding-top: 40px; border-top: 2px solid var(--border);">
                            <div class="generation-label" style="font-size: 16px; margin-bottom: 30px;">Extended Family Members</div>
                            <div class="generation-members">
                                ${extendedFamily.map(member => {
                                    const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                    return `
                                    <div class="family-member">
                                        <img src="${imageUrl}" 
                                             alt="${window.app.escapeHtml(member.name)}" 
                                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                        <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                        <div class="family-member-relation">${window.app.escapeHtml(member.nickname || 'Extended Family')}</div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                familyTree.innerHTML = html;
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFamily() {
            const modal = document.getElementById('familyModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('familyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFamily();
            }
        });

        // Function to load sample data
        function loadSampleData() {
            if (confirm('This will load sample family data. Do you want to continue?')) {
                const user = window.auth.getCurrentUser();
                if (!user || user.userId !== 'user123') {
                    alert('Sample data is only available for the demo user (user123)');
                    return;
                }
                
                fetch('data/sample-family.json')
                    .then(r => {
                        if (!r.ok) throw new Error('Failed to fetch: ' + r.status);
                        return r.json();
                    })
                    .then(sampleData => {
                            const dataKey = `life-trails-data-${user.userId}`;
                            localStorage.setItem(dataKey, JSON.stringify(sampleData));
                        localStorage.setItem('sample-data-loaded-user123', 'success');
                            alert('Sample data loaded successfully! The page will reload.');
                            location.reload();
                    })
                    .catch(err => {
                        alert('Error loading sample data: ' + err.message + '\nMake sure data/sample-family.json exists.');
                    });
            }
        }

        // Auto-load sample data for user123
        function checkAndOfferSampleData() {
            const user = window.auth.getCurrentUser();
            if (!user || user.userId !== 'user123') {
                return false;
            }
            
            const dataKey = `life-trails-data-${user.userId}`;
            const existingData = localStorage.getItem(dataKey);
            
            // Check if we have valid data with all years
            let hasData = false;
            let yearCount = 0;
            if (existingData) {
                try {
                    const data = JSON.parse(existingData);
                    const hasEvents = data.events && Object.keys(data.events).length > 0;
                    const hasFamily = data.family && data.family.length > 0;
                    yearCount = hasEvents ? Object.keys(data.events).length : 0;
                    hasData = hasEvents || hasFamily;
                } catch (e) {
                }
            }
            
            // If no data or less than 12 years (should have 15), reload
            if (!hasData || yearCount < 12) {
                // Clear old data flag to force reload
                localStorage.removeItem('sample-data-loaded-user123');
                // Try to load sample data immediately
                fetch('data/sample-family.json')
                    .then(r => {
                        if (!r.ok) throw new Error('Failed to fetch: ' + r.status);
                        return r.json();
                    })
                    .then(sampleData => {
                        const loadedYearCount = sampleData.events ? Object.keys(sampleData.events).length : 0;
                        localStorage.setItem(dataKey, JSON.stringify(sampleData));
                        localStorage.setItem('sample-data-loaded-user123', 'success');
                        window.location.reload();
                    })
                    .catch(err => {
                        localStorage.setItem('sample-data-loaded-user123', 'failed');
                    });
                return true; // Data is loading, don't call init yet
            }
            
            return false; // Data exists, safe to call init
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                const isLoading = checkAndOfferSampleData();
                if (!isLoading) {
                    setTimeout(init, 100);
                }
            });
        } else {
            const isLoading = checkAndOfferSampleData();
            if (!isLoading) {
                setTimeout(init, 100);
            }
        }

        // Expose loadSampleData globally for manual trigger
        window.loadSampleData = loadSampleData;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
                closeFamily();
                closeMobileMenu();
            }
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuBackdrop = document.getElementById('mobileMenuBackdrop');

        // Check if mobile viewport
        function isMobileView() {
            return window.innerWidth <= 768;
        }

        // Show/hide mobile menu button based on viewport
        function updateMobileMenuButton() {
            if (mobileMenuBtn) {
                if (isMobileView()) {
                    mobileMenuBtn.style.display = 'flex';
                    mobileMenuBtn.style.visibility = 'visible';
                    mobileMenuBtn.style.opacity = '1';
                } else {
                    mobileMenuBtn.style.display = 'none';
                }
            }
        }

        // Initial check
        updateMobileMenuButton();
        window.addEventListener('resize', updateMobileMenuButton);

        function toggleMobileMenu() {
            if (!mobileMenu || !mobileMenuBtn) return;
            const isActive = mobileMenu.classList.contains('active');
            mobileMenu.classList.toggle('active');
            mobileMenuBtn.classList.toggle('active');
            if (mobileMenuBackdrop) {
                mobileMenuBackdrop.classList.toggle('active');
            }
            document.body.style.overflow = !isActive ? 'hidden' : '';
            // Always ensure no background, regardless of state - use requestAnimationFrame to ensure it applies after transitions
            requestAnimationFrame(() => {
                mobileMenuBtn.style.setProperty('background', 'none', 'important');
                mobileMenuBtn.style.setProperty('background-color', 'transparent', 'important');
                mobileMenuBtn.style.setProperty('border', 'none', 'important');
                mobileMenuBtn.style.setProperty('box-shadow', 'none', 'important');
            });
        }

        function closeMobileMenu() {
            if (!mobileMenu || !mobileMenuBtn) return;
            mobileMenu.classList.remove('active');
            mobileMenuBtn.classList.remove('active');
            if (mobileMenuBackdrop) {
                mobileMenuBackdrop.classList.remove('active');
            }
            document.body.style.overflow = '';
            // Always ensure no background - use requestAnimationFrame and setTimeout to ensure it applies after transitions
            requestAnimationFrame(() => {
                setTimeout(() => {
                    mobileMenuBtn.style.setProperty('background', 'none', 'important');
                    mobileMenuBtn.style.setProperty('background-color', 'transparent', 'important');
                    mobileMenuBtn.style.setProperty('border', 'none', 'important');
                    mobileMenuBtn.style.setProperty('box-shadow', 'none', 'important');
                }, 100);
            });
        }

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleMobileMenu();
            });
            // Force styles
            if (isMobileView()) {
                mobileMenuBtn.style.display = 'flex';
                mobileMenuBtn.style.visibility = 'visible';
                mobileMenuBtn.style.opacity = '1';
                mobileMenuBtn.style.pointerEvents = 'auto';
                mobileMenuBtn.style.cursor = 'pointer';
                mobileMenuBtn.style.width = '32px';
                mobileMenuBtn.style.height = '32px';
                mobileMenuBtn.style.background = 'none';
                mobileMenuBtn.style.backgroundColor = 'transparent';
                mobileMenuBtn.style.border = 'none';
                mobileMenuBtn.style.borderRadius = '0';
                mobileMenuBtn.style.padding = '0';
                mobileMenuBtn.style.boxShadow = 'none';
                mobileMenuBtn.style.zIndex = '1001';
            }
        }

        // Make closeMobileMenu globally accessible
        window.closeMobileMenu = closeMobileMenu;

        // Close mobile menu when clicking backdrop or outside
        if (mobileMenuBackdrop) {
            mobileMenuBackdrop.addEventListener('click', closeMobileMenu);
        }
        
        // Close button click handler
        const mobileMenuClose = document.getElementById('mobileMenuClose');
        if (mobileMenuClose) {
            mobileMenuClose.addEventListener('click', closeMobileMenu);
        }
        
        document.addEventListener('click', (e) => {
            if (mobileMenu && mobileMenu.classList.contains('active')) {
                if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target) && !mobileMenuBackdrop.contains(e.target)) {
                    closeMobileMenu();
                }
            }
        });

        // Close mobile menu when clicking on menu items
        const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
        mobileMenuItems.forEach(item => {
            item.addEventListener('click', () => {
                setTimeout(closeMobileMenu, 100);
            });
        });

        // Scroll to Top Button
        const scrollToTopBtn = document.getElementById('scrollToTop');
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        window.scrollToTop = scrollToTop;
        
        function toggleScrollToTopButton() {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        }
        
        window.addEventListener('scroll', toggleScrollToTopButton);
        toggleScrollToTopButton(); // Check on load
    </script>

    <footer class="mobile-footer mobile-only">
        <div class="footer-content">
            <div class="footer-copyright">
                <p>Life Trails. Document your journey, preserve your legacy.</p>
                <p>&copy; 2026 <a href="https://trails.click" target="_blank" rel="noopener noreferrer" class="footer-link-text">Trails Labs</a>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <footer class="desktop-footer desktop-only">
        <div class="footer-content">
            <div class="footer-copyright">
                <p>Life Trails. Document your journey, preserve your legacy.</p>
                <p>&copy; 2026 <a href="https://trails.click" target="_blank" rel="noopener noreferrer" class="footer-link-text">Trails Labs</a>. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
