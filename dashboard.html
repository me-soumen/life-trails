<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Life Trails</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/theme.css">
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">
                <img src="images/logo.png" alt="Life Trails" class="logo-img">
                <span>Life Trails</span>
            </a>
            <nav class="header-nav"></nav>
        </div>
    </header>

    <div class="dashboard-layout">
        <aside>
            <h3>Years</h3>
            <div id="yearNav"></div>
        </aside>

        <div class="dashboard-main">
            <div class="dashboard-header">
                <div class="profile" id="profile"></div>
            <div class="action-buttons">
                <a href="add-event.html" class="btn btn-primary">‚ûï Add Event</a>
                <button onclick="openFamily()" class="btn btn-secondary">üë®‚Äçüë©‚Äçüë¶ View Family</button>
                <button onclick="window.loadSampleData && window.loadSampleData()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;" title="Load sample family data">üìã Load Sample Data</button>
            </div>
                <div class="search">
                    <input id="search" type="text" placeholder="Search by year, date, title, or description..." autocomplete="off" />
                </div>
            </div>

            <div class="timeline-container">
                <div id="timeline"></div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="image-modal-wrapper" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
            <img id="modalImg" alt="Event image" />
        </div>
    </div>

    <!-- Family Modal -->
    <div class="modal" id="familyModal" onclick="closeFamily()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Family Tree</h2>
                <button class="modal-close" onclick="closeFamily()">√ó</button>
            </div>
            <div id="familyTree"></div>
        </div>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/events.js"></script>
    <script src="js/family.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Check authentication
        if (!window.auth.requireAuth()) {
            // Redirect will happen in auth.js
        }

        let allEvents = [];

        function init() {
            const user = window.auth.getCurrentUser();
            if (!user) return;

            const data = window.eventsManager.getUserData();
            const profile = document.getElementById('profile');
            const timeline = document.getElementById('timeline');
            const yearNav = document.getElementById('yearNav');
            const search = document.getElementById('search');

            // Render profile
            profile.innerHTML = `
                <h1>${window.app.escapeHtml(data.name)}'s Life Trails</h1>
                <div class="meta">
                    <span>üéÇ ${window.app.escapeHtml(data.dateOfBirth || 'Not set')}</span>
                    <span>üìç ${window.app.escapeHtml(data.placeOfBirth || 'Not set')}</span>
                </div>
            `;

            // Get all events
            allEvents = window.eventsManager.getAllEvents();

            // Get unique years (reverse chronological)
            const years = [...new Set(allEvents.map(e => e.year))].sort((a, b) => b - a);

            function render(filter = '') {
                timeline.innerHTML = '';
                yearNav.innerHTML = '';

                // Filter events
                const filteredEvents = filter
                    ? allEvents.filter(e => {
                        const searchText = filter.toLowerCase();
                        return (
                            e.year.includes(searchText) ||
                            e.date.toLowerCase().includes(searchText) ||
                            e.title.toLowerCase().includes(searchText) ||
                            e.description.toLowerCase().includes(searchText) ||
                            (e.place && e.place.toLowerCase().includes(searchText))
                        );
                    })
                    : allEvents;

                if (filteredEvents.length === 0) {
                    timeline.innerHTML = `
                        <div class="empty-state">
                            <h3>No events found</h3>
                            <p>Try adjusting your search terms or <a href="add-event.html">add your first event</a>.</p>
                        </div>
                    `;
                    return;
                }

                // Group by year
                const eventsByYear = {};
                filteredEvents.forEach(event => {
                    if (!eventsByYear[event.year]) {
                        eventsByYear[event.year] = [];
                    }
                    eventsByYear[event.year].push(event);
                });

                // Render year navigation
                Object.keys(eventsByYear).sort((a, b) => b - a).forEach(year => {
                    const yearId = `year-${year}`;
                    yearNav.innerHTML += `<a class="year-link" href="#${yearId}">${year}</a>`;
                });

                // Render timeline
                Object.keys(eventsByYear).sort((a, b) => b - a).forEach(year => {
                    const yearId = `year-${year}`;
                    const section = document.createElement('div');
                    section.className = 'section';
                    section.id = yearId;

                    const yearHeader = document.createElement('div');
                    yearHeader.className = 'year';
                    yearHeader.textContent = year;
                    section.appendChild(yearHeader);

                    // Group events by month (reverse chronological)
                    const eventsByMonth = {};
                    eventsByYear[year].forEach(event => {
                        const month = new Date(event.date).toLocaleString('default', { month: 'long' });
                        if (!eventsByMonth[month]) {
                            eventsByMonth[month] = [];
                        }
                        eventsByMonth[month].push(event);
                    });

                    // Sort months reverse chronologically
                    const sortedMonths = Object.keys(eventsByMonth).sort((a, b) => {
                        const monthA = new Date(`${year}-${window.app.getMonthNumber(a)}-01`);
                        const monthB = new Date(`${year}-${window.app.getMonthNumber(b)}-01`);
                        return monthB - monthA;
                    });

                    sortedMonths.forEach(month => {
                        const monthGroup = document.createElement('div');
                        monthGroup.className = 'month-group';

                        const monthHeader = document.createElement('div');
                        monthHeader.className = 'month';
                        monthHeader.textContent = month;
                        monthGroup.appendChild(monthHeader);

                        // Sort events within month (reverse chronological - latest first)
                        const monthEvents = eventsByMonth[month].sort((a, b) => b.sortDate - a.sortDate);

                        monthEvents.forEach(event => {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'event';

                            // Limit images to 2
                            const displayImages = (event.images || []).slice(0, 2);
                            const imageClass = displayImages.length === 1 ? 'single' : '';
                            const user = window.auth.getCurrentUser();

                            eventDiv.innerHTML = `
                                <div class="card">
                                    <div class="meta-line">
                                        <span>üìÖ ${window.app.escapeHtml(event.date)}</span>
                                        <span>‚è∞ ${window.app.escapeHtml(event.time)}</span>
                                        ${event.place ? `<span>üìç ${window.app.escapeHtml(event.place)}</span>` : ''}
                                    </div>
                                    <div class="event-title">${window.app.escapeHtml(event.title)}</div>
                                    <div class="event-description">${window.app.escapeHtml(event.description)}</div>
                                    ${displayImages.length > 0 ? `
                                        <div class="images ${imageClass}">
                                            ${displayImages.map(img => {
                                                const imageUrl = window.app.getImageUrl(user.userId, img);
                                                return `
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(event.title)}" 
                                                     onerror="this.style.display='none'"
                                                     onclick="openImageModal('${imageUrl}')" />
                                            `;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;

                            monthGroup.appendChild(eventDiv);
                        });

                        section.appendChild(monthGroup);
                    });

                    timeline.appendChild(section);
                });
            }

            search.addEventListener('input', (e) => {
                render(e.target.value);
            });

            // Smooth scroll for year links
            yearNav.addEventListener('click', (e) => {
                if (e.target.classList.contains('year-link')) {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });

            render();
        }

        // Image Modal
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            modalImg.src = imageSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Family Modal
        function openFamily() {
            const modal = document.getElementById('familyModal');
            const familyTree = document.getElementById('familyTree');

            const allFamily = window.familyManager.getFamily();
            
            // Separate regular family and extended family (Others)
            const regularFamily = allFamily.filter(m => m.relation !== 'Others');
            const extendedFamily = allFamily.filter(m => m.relation === 'Others');

            if (regularFamily.length === 0 && extendedFamily.length === 0) {
                familyTree.innerHTML = `
                    <div class="empty-state">
                        <h3>No family members added yet</h3>
                        <p><a href="add-family.html">Add your first family member</a></p>
                    </div>
                `;
            } else {
                let html = '';
                
                // Build main family tree (excluding Others)
                if (regularFamily.length > 0) {
                    const familyLevels = {};
                    regularFamily.forEach(member => {
                        if (!familyLevels[member.level]) {
                            familyLevels[member.level] = [];
                        }
                        familyLevels[member.level].push(member);
                    });

                    const sortedLevels = Object.keys(familyLevels)
                        .map(Number)
                        .sort((a, b) => a - b);

                    sortedLevels.forEach((level, index) => {
                        const generation = familyLevels[level];
                        const user = window.auth.getCurrentUser();
                        
                        // Special handling for level 0 (Self/Siblings/Spouse)
                        if (level === 0) {
                            const self = generation.filter(m => m.relation === 'Self');
                            const spouse = generation.filter(m => m.relation === 'Spouse');
                            const siblings = generation.filter(m => m.relation === 'Brother' || m.relation === 'Sister');
                            
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${[...self, ...spouse].map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            const isSelf = member.relation === 'Self';
                                            return `
                                            <div class="family-member ${isSelf ? 'family-member-self' : ''}">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     class="${isSelf ? 'family-member-self-img' : ''}"
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name ${isSelf ? 'family-member-self-name' : ''}">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation === 'Self' ? 'Self' : 'Spouse')}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                        ${siblings.length > 0 ? '<div class="generation-separator-inline">‚îÇ</div>' : ''}
                                        ${siblings.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">‚îÇ</div>' : ''}
                                </div>
                            `;
                        } else if (level === -2) {
                            // Special handling for grandparents - separate Father Side and Mother Side
                            const fatherSide = generation.filter(m => m.relation.includes('Father Side'));
                            const motherSide = generation.filter(m => m.relation.includes('Mother Side'));
                            
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${fatherSide.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                        ${motherSide.length > 0 ? '<div class="generation-separator-inline">‚îÇ</div>' : ''}
                                        ${motherSide.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">‚îÇ</div>' : ''}
                                </div>
                            `;
                        } else {
                            // Other levels (parents, grandparents, children)
                            html += `
                                <div class="generation">
                                    <div class="generation-label">${window.familyManager.getGenerationLabel(level)}</div>
                                    <div class="generation-members">
                                        ${generation.map(member => {
                                            const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                            return `
                                            <div class="family-member">
                                                <img src="${imageUrl}" 
                                                     alt="${window.app.escapeHtml(member.name)}" 
                                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                                <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                                <div class="family-member-relation">${window.app.escapeHtml(member.relation)}</div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                    ${index < sortedLevels.length - 1 ? '<div class="generation-connector">‚îÇ</div>' : ''}
                                </div>
                            `;
                        }
                    });
                }

                // Add Extended Family Members section
                if (extendedFamily.length > 0) {
                    const user = window.auth.getCurrentUser();
                    html += `
                        <div style="margin-top: 60px; padding-top: 40px; border-top: 2px solid var(--border);">
                            <div class="generation-label" style="font-size: 16px; margin-bottom: 30px;">Extended Family Members</div>
                            <div class="generation-members">
                                ${extendedFamily.map(member => {
                                    const imageUrl = window.app.getImageUrl(user.userId, member.image);
                                    return `
                                    <div class="family-member">
                                        <img src="${imageUrl}" 
                                             alt="${window.app.escapeHtml(member.name)}" 
                                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23334155%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'" />
                                        <div class="family-member-name">${window.app.escapeHtml(member.name)}</div>
                                        <div class="family-member-relation">${window.app.escapeHtml(member.nickname || 'Extended Family')}</div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                familyTree.innerHTML = html;
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFamily() {
            const modal = document.getElementById('familyModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('familyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFamily();
            }
        });

        // Function to load sample data
        function loadSampleData() {
            if (confirm('This will load sample family data. Do you want to continue?')) {
                fetch('data/sample-family.json')
                    .then(r => r.json())
                    .then(sampleData => {
                        const user = window.auth.getCurrentUser();
                        if (user && user.userId === 'user123') {
                            const dataKey = `life-trails-data-${user.userId}`;
                            localStorage.setItem(dataKey, JSON.stringify(sampleData));
                            alert('Sample data loaded successfully! The page will reload.');
                            location.reload();
                        } else {
                            alert('Sample data is only available for the demo user (user123)');
                        }
                    })
                    .catch(err => {
                        console.error('Error loading sample data:', err);
                        alert('Error loading sample data. Make sure data/sample-family.json exists.');
                    });
            }
        }

        // Check if user has no data and offer to load sample
        function checkAndOfferSampleData() {
            const user = window.auth.getCurrentUser();
            if (user && user.userId === 'user123') {
                const data = window.eventsManager.getUserData();
                if (!data.family || data.family.length === 0) {
                    const loadSample = confirm('No family data found. Would you like to load sample family data?');
                    if (loadSample) {
                        loadSampleData();
                    }
                }
            }
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                init();
                checkAndOfferSampleData();
            });
        } else {
            init();
            checkAndOfferSampleData();
        }

        // Expose loadSampleData globally for manual trigger
        window.loadSampleData = loadSampleData;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
                closeFamily();
            }
        });
    </script>
</body>
</html>
